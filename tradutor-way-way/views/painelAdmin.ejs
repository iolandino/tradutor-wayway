<main class="painelAdmin-content">
    <h1>Painel do Administrador</h1>
    <br>
    <section class="painelAdmin-contain" id="gerenciar">
        <h2>Usu√°rios</h2>
        <table class="tabela-usuarios">
            <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Tipos</th>
                <th>A√ß√µes</th>
            </tr>
            <% usuarios.forEach(u => { %>
                <tr>
                    <td><%= u.nome %></td>
                    <td><%= u.email %></td>
                    <td><%= u.tipos.join(', ') %></td>
                    <td>
                        <% if (u.id !== admin.id) { %>
                            <% if (u.tipos.includes('admin')) { %>
                                <!-- J√° √© admin, pode apenas remover -->
                                <form method="post" action="/admin/rebaixar-admin/<%= u._id %>" style="display:inline">
                                    <button type="submit">Remover Admin</button>
                                </form>
                            <% } else { %>
                                <!-- N√£o √© admin, mostrar op√ß√£o de promover -->
                                <form method="post" action="/admin/promover-admin/<%= u._id %>" style="display:inline">
                                    <button type="submit">Tornar Admin</button>
                                </form>
                                <!-- Somente se n√£o for admin, mostrar bot√µes de tradutor -->
                                <% if (!u.tipos.includes('tradutor')) { %>
                                    <form method="post" action="/admin/promover-tradutor/<%= u._id %>" style="display:inline">
                                        <button type="submit">Tornar Tradutor</button>
                                    </form>
                                <% } else { %>
                                    <form method="post" action="/admin/rebaixar-tradutor/<%= u._id %>" style="display:inline">
                                        <button type="submit">Remover Tradutor</button>
                                    </form>
                                <% } %>
                            <% } %>
                        <% } %>
                    </td>
                </tr>
            <% }) %>
        </table>

        <br><br><hr><br><br>

        <h2>Solicita√ß√µes pendentes para Tradutor</h2>
        <% if (solicitacoesPendentes.length === 0) { %>
            <p>Nenhuma solicita√ß√£o pendente.</p>
        <% } else { %>
            <table class="tabela-sugestoes">
                <thead>
                    <tr>
                        <th>Solicitado por</th>
                        <th>Data da Solicita√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <% solicitacoesPendentes.forEach(s => { %>
                        <tr>
                            <td><%= s.solicitadoPor?.nome %></td>
                            <td><%= s.dataSolicitacao.toLocaleDateString() %></td>
                            <td>
                                <button onclick="aprovarSolicitacao('<%= s._id %>')">‚úÖ Aprovar</button>
                                <button onclick="rejeitarSolicitacao('<%= s._id %>')">‚ùå Rejeitar</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>

        <br><hr><br>

        <h2>Todas as Solicita√ß√µes</h2>
        <% if (solicitacoes.length === 0) { %>
            <p>Ainda n√£o h√° solicita√ß√µes.</p>
        <% } else { %>
            <table class="tabela-sugestoes">
                <thead>
                    <tr>
                        <th>Solicitado por</th>
                        <th>Data da Solicita√ß√£o</th>
                        <th>Status</th>
                        <th>Mensagem</th>
                        <th>Avaliada por</th>
                        <th>Data da Avalia√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <% solicitacoes.forEach(s => { %>
                        <tr>
                            <td><%= s.solicitadoPor?.nome %></td>
                            <td><%= s.dataSolicitacao.toLocaleDateString() %></td>
                            <td>
                                <% if (s.status === 'aprovada') { %>
                                    <span style="color: green;">Aprovada</span>
                                <% } else if (s.status === 'rejeitada') { %>
                                    <span style="color: red;">Rejeitada</span>
                                <% } else if (s.status === 'pendente') { %>
                                    <span style="color: orange;">Pendente</span>
                                <% } else if (s.status === 'cancelada') { %>
                                    <span style="color: gray;">Cancelada</span>
                                <% } %>
                            </td>
                            <td><%= s.mensagemAdmin || '-' %></td>
                            <td><%= s.avaliadoPor?.nome || '-' %></td>
                            <td>
                                <% if (s.status === 'aprovada' || s.status === 'rejeitada') { %>
                                    <%= s.dataAvaliacao.toLocaleDateString() || '-' %>
                                <% } else if (s.status === 'cancelada') { %>
                                    <%= s.dataCancelamento?.toLocaleDateString() || '-' %>
                                <% } else { %>
                                    -
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>

        <br><br><hr><br><br>
        
        <h2>Solicita√ß√µes de Desvincula√ß√£o de Administrador (Pendentes)</h2>
        <% if (desvinculosAdminPendentes.length === 0) { %>
            <p>Nenhuma solicita√ß√£o pendente.</p>
        <% } else { %>
            <table class="tabela-sugestoes">
                <thead>
                    <tr>
                        <th>Solicitante</th>
                        <th>Justificativa</th>
                        <th>Data</th>
                        <th>Aprova√ß√µes</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <% desvinculosAdminPendentes.forEach(s => { %>
                        <tr>
                            <td><%= s.solicitante?.nome %></td>
                            <td><%= s.justificativa %></td>
                            <td><%= s.dataSolicitacao.toLocaleDateString() %></td>
                            <td>
                                <% s.aprovadores.forEach(ap => { %>
                                    <div>
                                        <%= ap.admin?.nome %>: 
                                        <% if (ap.aprovou) { %>
                                          ‚úÖ
                                        <% } else { %>
                                          ‚è≥
                                        <% } %>
                                    </div>
                                <% }) %>
                            </td>
                            <td>
                                <% const aprovador = s.aprovadores.find(ap => ap.admin && ap.admin._id.toString() === admin._id.toString()); %>
                                <% if (aprovador && !aprovador.aprovou) { %>
                                    <button onclick="aprovarDesvinculoAdmin('<%= s._id %>')">‚úÖ Aprovar</button>
                                <% } else if (aprovador && aprovador.aprovou) { %>
                                    <span>Voc√™ j√° aprovou</span>
                                <% } else { %>
                                    <span>Voc√™ n√£o √© avaliador</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>

        <br><hr><br>

        <h2>Solicita√ß√µes de Desvincula√ß√£o de Administrador (Todas) </h2>

        <% if (desvinculosAdmin.length === 0) { %>
            <p>Nenhuma solicita√ß√£o de desvincula√ß√£o ativa.</p>
        <% } else { %>
            <table class="tabela-sugestoes">
                <thead>
                    <tr>
                        <th>Solicitante</th>
                        <th>Justificativa</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>Aprova√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <% desvinculosAdmin.forEach(d => { %>
                        <tr>
                            <td><%= d.solicitante?.nome || 'Desconhecido' %></td>
                            <td><%= d.justificativa %></td>
                            <td>
                                <% if (d.status === 'aprovada') { %>
                                  <span style="color: green;">Aprovada</span>
                                <% } else if (d.status === 'rejeitada') { %>
                                  <span style="color: red;">Rejeitada</span>
                                <% } else { %>
                                <span style="color: orange;">Pendente</span>
                                <% } %>
                            </td>
                            <td><%= d.dataSolicitacao.toLocaleDateString() %></td>
                            <td>
                                <% d.aprovadores.forEach(ap => { %>
                                    <div>
                                        <%= ap.admin?.nome %>: 
                                            <% if (ap.aprovou) { %>
                                                ‚úÖ
                                            <% } else { %>
                                                ‚è≥
                                            <% } %>
                                    </div>
                                <% }) %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>

        <br><br><hr><br><br>
  
        <h2>Termos Cadastrados</h2>
        <% if (palavras.length === 0) { %>
            <p>Nenhum termo cadastrado.</p>
        <% } else { %>
            <table class="tabela-termos">
                <thead>
                    <tr>
                        <th>Portugu√™s</th>
                        <th>Wai Wai</th>
                        <th>Criado Por</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <% palavras.forEach(p => { %>
                        <tr>
                            <td><%= p.portugues %></td>
                            <td><%= p.waiwai %></td>
                            <td><%= p.criadoPor?.nome || 'Desconhecido' %></td>
                            <td>
                                <button onclick="editarTermo('<%= p._id %>')">‚úèÔ∏è Editar</button>
                                <button onclick="removerTermo('<%= p._id %>')">üóëÔ∏è Remover</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
  
        <br><br><hr><br><br>
  
        <h2>Sugest√µes Pendentes</h2>
        <% if ( sugestoesPendentes.length === 0) { %>
            <p>Nenhuma sugest√£o pendente.</p>
        <% } else { %>
            <table class="tabela-sugestoes">
                <thead>
                    <tr>
                        <th>Portugu√™s</th>
                        <th>Wai Wai</th>
                        <th>Descri√ß√£o</th>
                        <th>Enviado por</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <% sugestoesPendentes.forEach(s => { %>
                        <tr>
                            <td><%= s.portugues %></td>
                            <td><%= s.waiwai %></td>
                            <td><%= s.descricao || '-' %></td>
                            <td><%= s.sugeridoPor?.nome || 'Desconhecido' %></td>
                            <td>
                                <button onclick="aprovarSugestao('<%= s._id %>')">‚úÖ Aprovar</button>
                                <button onclick="rejeitarSugestao('<%= s._id %>')">‚ùå Rejeitar</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>

        <br><hr><br>

        <h2>Todas as Sugest√µes</h2>
        <% if (sugestoes.length === 0) { %>
            <p>Ainda n√£o h√° sugest√µes.</p>
        <% } else { %>
            <table class="tabela-sugestoes">
                <thead>
                    <tr>
                        <th>Portugu√™s</th>
                        <th>Wai Wai</th>
                        <th>Descri√ß√£o</th>
                        <th>Enviado por</th>
                        <th>Status</th>
                        <th>Mensagem</th>
                    </tr>
                </thead>
                <tbody>
                <% sugestoes.forEach(s => { %>
                    <tr>
                        <td><%= s.portugues %></td>
                        <td><%= s.waiwai %></td>
                        <td><%= s.descricao || '-' %></td>
                        <td><%= s.sugeridoPor?.nome || 'Desconhecido' %></td>
                        <td>
                            <% if (s.status === 'aprovada') { %>
                                <span style="color: green;">Aprovada</span>
                            <% } else if (s.status === 'rejeitada') { %>
                                <span style="color: red;">Rejeitada</span>
                            <% } else if (s.status === 'pendente') { %>
                                <span style="color: orange;">Pendente</span>
                            <% } %>
                        </td>
                        <td><%= s.mensagemAvaliador || '-' %></td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        <% } %>
    </section>

    <section class="editarTermos-content" id="editarTermos" hidden>
        <div class="editarTermos-contain">
        <h2 style="text-align: center;">Editar Termo</h2>
        <form id="formEditarTermo">
            <input type="hidden" id="editarTermoId" />
    
            <label>Portugu√™s:
                <input type="text" id="editarTermoPt" required />
            </label>
    
            <label>Wai Wai:
                <input type="text" id="editarTermoWai" required />
            </label>

            <label>Descri√ß√£o:
                <textarea id="editarTermoDescricao"></textarea>
            </label>

            <button type="submit">Salvar Altera√ß√µes</button>
            <button type="button" onclick="cancelarEdicaoTermo()">Cancelar</button>
        </form>
        </div>
    </section>
</main>

<!-- Modal Aprovar Solicita√ß√£o -->
<div id="aprovar-solicitacao" class="modal-aprovar" hidden>
  <div class="solicitacao-contain">
    <h3>Aprovar Solicita√ß√£o</h3>
    <input type="hidden" id="solicitacaoIdAprovar">
    <label>Mensagem ao usu√°rio (opcional):</label>
    <textarea id="mensagemAprovarSolicitacao" placeholder="Mensagem..."></textarea>
    <div class="modal-buttons">
      <button onclick="confirmarSolicitacao()">Aprovar</button>
      <button onclick="fecharModal('aprovar-solicitacao')">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Rejeitar Solicita√ß√£o -->
<div id="rejeitar-solicitacao" class="modal-rejeitar" hidden>
  <div class="solicitacao-contain">
    <h3>Rejeitar Solicita√ß√£o</h3>
    <input type="hidden" id="solicitacaoIdRejeitar">
    <label>Por que est√° rejeitando? (opcional):</label>
    <textarea id="mensagemRejeitarSolicitacao" placeholder="Motivo..."></textarea>
    <div class="modal-buttons">
      <button onclick="recusarSolicitacao()">Rejeitar</button>
      <button onclick="fecharModal('rejeitar-solicitacao')">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Aprovar Sugest√£o -->
<div id="aprovar-sugestao" class="modal-aprovar" hidden>
  <div class="sugestao-contain">
    <h3>Aprovar Sugest√£o</h3>
    <input type="hidden" id="sugestaoIdAprovar">
    <label>Mensagem ao usu√°rio (opcional):</label>
    <textarea id="mensagemAprovar" placeholder="Mensagem..."></textarea>
    <div class="modal-buttons">
      <button onclick="confirmarAprovacao()">Aprovar</button>
      <button onclick="fecharModal('aprovar-sugestao')">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Rejeitar Sugest√£o -->
<div id="rejeitar-sugestao" class="modal-rejeitar" hidden>
  <div class="sugestao-contain">
    <h3>Rejeitar Sugest√£o</h3>
    <input type="hidden" id="sugestaoIdRejeitar">
    <label>Por que est√° rejeitando? (opcional):</label>
    <textarea id="mensagemRejeitar" placeholder="Motivo..."></textarea>
    <div class="modal-buttons">
      <button onclick="confirmarRejeicao()">Rejeitar</button>
      <button onclick="fecharModal('rejeitar-sugestao')">Cancelar</button>
    </div>
  </div>
</div>

<script src="/javascripts/gerenciar.js"></script>